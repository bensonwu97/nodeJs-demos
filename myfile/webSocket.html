<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>在线聊天</title>
    <link rel="stylesheet" href="css/talk.css">
</head>
<body>
    <h2>在线聊天室</h2>
    <p>当前在线人数 : <span class="userNum">--</span> 用户名:<span class="username">--</span></p>
    <section class="talk-section">

    </section>
    <div class="talk-btn">
        <input type="text" class="btn inp-message" placeholder="输入消息">
        <button class="btn btn-send">发送</button>
    </div>
</body>
<script src='js/jquery-1.11.3.js'></script>
<script src='js/browser.min.js'></script>
<!--这里是个坑 不是相对路径  服务器启动后会生成一个socket.io的路径-->
<script src="/socket.io/socket.io.js"></script>
<script>
    $(()=>{
        //建立socket
        let socket = io.connect('http://localhost:666');
        //连接
        //接受到当前登录用户后  发送给后台 
        user('/user').then((username)=>{
            socket.emit('login',username);
        })
        //监听用户进入
        socket.on('login',( data )=>{
            console.log('用户登录成功--用户信息：',data)
            let {userNum,username} = data;
            $('.userNum').text(userNum);
            $('.username').text(username.username);
            $('.talk-section').append($('<div>连接服务器成功~可以开始说骚话了</div>'))
        });
        //接受服务器发过来的消息
        socket.on('message', messageInfo =>{
            console.log('服务器发来消息',messageInfo )
            var $text = $('<p class="message">'+ messageInfo.message +'<span class="message-info">'+ messageInfo.username +'<span class="message-time">'+ messageInfo.time +'</span></p>');
            $('.talk-section').append($text).scrollTop( $('.talk-section')[0].scrollHeight)

        })
        socket.on('error',error =>{
            console.log('error',error)
        })

        let $btnSend = $('.btn-send');
        $btnSend.on('click',()=>{
            sendMessage(socket)
                .then(data=>{
                    $('.inp-message').val("").focus();
                    console.log('发送成功=>消息',data)

                }).catch(e=>{
                    console.log('error',e)
                }); 
        })

    })

    //发送消息给服务器
    function sendMessage( socket ){
        return new Promise((res,rej)=>{
            let $message = $('.inp-message').val();
            let date = new Date();
            let time = date.getHours() + ":" + date.getMinutes()+":" + date.getSeconds();
            socket.send({
                message:$message,
                time:time
            });
            res({
                message:$message,
                time:time
            });
        })
    }

    //用户当前登录用户信息
    function user( url ){
        return new Promise(( res,rej )=>{
            $.ajax({
                type:"GET",
                url:url,
                data:{},
                dataType:"json",
                beforeSend(){
                    load = new loadingPopup();
                },
                success( user ){
                    load.remove();
                    res(user)
                },
                error(e){
                    rej(e)
                }
            })
        })
    }

    //遮罩层
    function loadingPopup(){
        this.load = $('<div class="loading"><div>获取中。。。</div></div>');
        $('body').append(this.load);
    }
    loadingPopup.prototype.remove = function(){
        this.load.remove();
    }
</script>
</html>